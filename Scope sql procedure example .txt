DELIMITER $$

CREATE PROCEDURE AdjustSharesByScope(IN scope_type VARCHAR(50))
BEGIN
    IF scope_type = 'category' THEN
        -- Recalculate value_share and volume_share within each category
        UPDATE DerivedCalculations d
        JOIN RAWDATA r ON d.rawdata_id = r.id
        JOIN (
            SELECT 
                category_id, 
                SUM(value_sales) AS category_value_sales,
                SUM(volume_sales) AS category_volume_sales
            FROM RAWDATA
            GROUP BY category_id
        ) c ON r.category_id = c.category_id
        SET 
            d.value_share = r.value_sales / c.category_value_sales,
            d.volume_share = r.volume_sales / c.category_volume_sales;
    ELSEIF scope_type = 'brand' THEN
        -- Recalculate value_share and volume_share within each brand
        UPDATE DerivedCalculations d
        JOIN RAWDATA r ON d.rawdata_id = r.id
        JOIN (
            SELECT 
                brand_id, 
                SUM(value_sales) AS brand_value_sales,
                SUM(volume_sales) AS brand_volume_sales
            FROM RAWDATA
            GROUP BY brand_id
        ) b ON r.brand_id = b.brand_id
        SET 
            d.value_share = r.value_sales / b.brand_value_sales,
            d.volume_share = r.volume_sales / b.brand_volume_sales;
    -- Add additional scope types as needed (e.g., region, size bracket)
    ELSE
        -- Default or error handling if an unsupported scope is provided
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Unsupported scope type provided';
    END IF;
END $$

DELIMITER ;



-- Call proceducre 

CALL AdjustSharesByScope('category');